<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ê²Œì‹œê¸€ ë³´ê¸°</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    .container {
      max-width: 700px;
      margin: auto;
      padding: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      text-align: left;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    .post-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: gray;
      text-align: left;
    }

    .post-author {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .post-author img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
    }

    .post-content {
      margin-top: 20px;
      font-size: 16px;
      white-space: pre-wrap;
    }

    .post-tags {
      margin-top: 10px;
      font-size: 14px;
      color: #555;
    }

    .post-tags .tag {
      display: inline-block;
      background: #eee;
      padding: 5px 10px;
      margin-right: 5px;
      border-radius: 5px;
      font-size: 13px;
    }

    .post-media {
      margin-top: 15px;
    }

    .post-media img, .post-media video, .post-media audio {
      max-width: 100%;
      display: block;
      margin-top: 5px;
      border-radius: 5px;
    }

    .button-container {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .edit-button, .delete-button {
      padding: 10px 15px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: none;
    }

    .edit-button {
      background-color: #007bff;
      color: white;
    }

    .edit-button:hover {
      background-color: #0056b3;
    }

    .delete-button {
      background-color: #f44336;
      color: white;
    }

    .delete-button:hover {
      background-color: #c9302c;
    }

    .back-button {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: gray;
      padding: 8px 12px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    /* ğŸ”¥ ëŒ“ê¸€ ì „ì²´ ìŠ¤íƒ€ì¼ */
    #comments-list {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    /* ğŸ”¥ ê°œë³„ ëŒ“ê¸€ ë°•ìŠ¤ */
    .comment-box {
        background: #fff;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }
    
    /* ğŸ”¥ ëŒ“ê¸€ í—¤ë” (í”„ë¡œí•„ & ë‹‰ë„¤ì„ & ì‹œê°„) */
    .comment-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
    }
    
    /* ğŸ”¥ ëŒ“ê¸€ í”„ë¡œí•„ ì‚¬ì§„ */
    .comment-profile {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #ddd;
    }
    
    /* ğŸ”¥ ëŒ“ê¸€ ì •ë³´ (ë‹‰ë„¤ì„ & ì‹œê°„) */
    .comment-info {
        display: flex;
        flex-direction: column;
    }
    
    /* ğŸ”¥ ë‹‰ë„¤ì„ ìŠ¤íƒ€ì¼ */
    .comment-username {
        font-weight: bold;
    }
    
    /* ğŸ”¥ ëŒ“ê¸€ ì‘ì„± ì‹œê°„ */
    .comment-time {
        font-size: 12px;
        color: gray;
    }
    
    /* ğŸ”¥ ëŒ“ê¸€ ë‚´ìš© */
    .comment-content {
        font-size: 14px;
        line-height: 1.4;
    }
    .comment-input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        display: flex;
        align-items: center;
        background: white;
        padding: 10px;
        border-top: 1px solid #ddd;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .comment-input-container textarea {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: none;
        height: 40px;
    }
    
    .media-upload-button {
        cursor: pointer;
        font-size: 20px;
        margin-right: 10px;
    }
    
    #add-comment {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
    }
    
    #add-comment:hover {
        background: #0056b3;
    }
    /* ğŸ”¥ ëŒ“ê¸€ ì…ë ¥ ì¹¸ì„ í•­ìƒ í™”ë©´ í•˜ë‹¨ì— ê³ ì • */
    .comment-input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: white;
        padding: 10px;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1000;
    }
    
    /* ğŸ”¥ ëŒ“ê¸€ ì…ë ¥ í•„ë“œ */
    #comment-input {
        flex: 1;
        min-height: 40px;
        padding: 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: none; /* í¬ê¸° ì¡°ì ˆ ë°©ì§€ */
        overflow-y: auto; /* ì…ë ¥ì´ ê¸¸ì–´ì§€ë©´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    }
    
    /* ğŸ”¥ ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ */
    #add-comment {
        padding: 10px 15px;
        font-size: 14px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.2s;
        white-space: nowrap; /* ë²„íŠ¼ í¬ê¸° ìœ ì§€ */
    }
    
    #add-comment:hover {
        background: #0056b3;
    }
    
    /* ğŸ”¥ ì „ì²´ í˜ì´ì§€ì—ì„œ ëŒ“ê¸€ ì…ë ¥ ì¹¸ì„ ê³ ë ¤í•œ ìŠ¤í¬ë¡¤ */
    body {
        padding-bottom: 80px; /* ëŒ“ê¸€ ì…ë ¥ ì¹¸ë§Œí¼ ì—¬ë°± ì¶”ê°€ */
    }
    #comment-input {
        max-height: 150px; /* ì…ë ¥ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ ìµœëŒ€ ë†’ì´ ì„¤ì • */
        overflow-y: auto;
    }
    /* ğŸ”¥ ëŒ“ê¸€ ì˜µì…˜ (í†±ë‹ˆë°”í€´) */
    .comment-options {
        position: relative;
        margin-left: auto;
        cursor: pointer;
        font-size: 18px;
        padding: 5px;
        color: gray;
        transition: 0.2s;
    }
    
    .comment-options:hover {
        color: black;
    }
    
    /* ğŸ”¥ ëŒ“ê¸€ ì˜µì…˜ ë©”ë‰´ */
    .comment-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 25px;
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        z-index: 10;
        width: 100px;
        text-align: left;
    }
    
    .comment-menu button {
        display: block;
        width: 100%;
        padding: 8px;
        border: none;
        background: white;
        font-size: 14px;
        cursor: pointer;
        text-align: left;
    }
    
    .comment-menu button:hover {
        background: #f4f4f4;
    }

  </style>
  <link rel="icon" href="https://www.google.com/favicon.ico" type="image/x-icon">
</head>
<body>

  <!-- ğŸ”™ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
  <div class="back-button" id="backbtn">â† ëŒì•„ê°€ê¸°</div>

  <div class="container">
    <h2 id="post-title">ê²Œì‹œê¸€ ì œëª©</h2>
    <div class="post-meta">
      <div class="post-author" id="post-author">
        <img src="default-icon.png" alt="ì‘ì„±ì í”„ë¡œí•„" id="author-icon">
        <span id="author-name">ì‘ì„±ì</span>
      </div>
      <span id="post-date">ì‘ì„±ì¼</span>
    </div>

    <!-- íƒœê·¸ ë° ë¯¸ë””ì–´ -->
    <div class="post-tags" id="post-tags"></div>
    <div class="post-media" id="post-media"></div>

    <div class="post-content" id="post-content">ê²Œì‹œê¸€ ë‚´ìš©</div>

    <!-- ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ -->
    <div class="button-container">
      <button class="edit-button" id="edit-btn">âœ ìˆ˜ì •</button>
      <button class="delete-button" id="delete-btn">ğŸ—‘ ì‚­ì œ</button>
    </div>
  </div>
  
  <p id="post-views">ì¡°íšŒìˆ˜ 0 views</p>

  <div class="like-dislike-container">
    <button id="like-btn">â‡§ ì¢‹ì•„ìš” <span id="like-count">0</span></button>
    <button id="dislike-btn">â‡© ì‹«ì–´ìš” <span id="dislike-count">0</span></button>
  </div>

  <div class="comments-section">
     <h3>ëŒ“ê¸€</h3>
      <div id="comments-list"></div>
  </div>

  <!-- ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
  <div id="media-preview-container" style="display: none;">
      <div id="media-preview"></div>
      <button id="remove-media">âŒ</button>
  </div>


  <div class="comment-input-container">
    <input type="file" id="comment-media-upload" accept="image/*,video/*" hidden>
    <label for="comment-media-upload" class="media-upload-button" id="upload-btn">ğŸŒ</label>
    <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <button id="add-comment">âœ ì‘ì„±</button>
  </div>


  <script type="module" defer>
    import { db, auth } from "./auth.js";
    import { getFirestore, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
    import { loadPost } from "./post.js";

    document.addEventListener("DOMContentLoaded", () => {
        console.log("âœ… post-view.html DOMContentLoaded ì‹¤í–‰ë¨!");

        const urlParams = new URLSearchParams(window.location.search);
        const board = urlParams.get("board"); 
        const postId = urlParams.get("id");

        console.log("âœ… URLì—ì„œ ê°€ì ¸ì˜¨ ê°’ - board:", board);
        console.log("âœ… URLì—ì„œ ê°€ì ¸ì˜¨ ê°’ - postId:", postId);

        if (!board || !postId) {
            console.error("error:303 <ê²Œì‹œíŒ ë˜ëŠ” ê²Œì‹œê¸€ IDê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤>");
            return;
        }

        loadPost(board, postId); // âœ… Firestoreì—ì„œ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    });

    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get("id");
    const board = urlParams.get("board"); 

    if (!postId || !board) {
      alert(error:unknown[3] <ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤>");
      window.location.href = "bullboard.html";
    }

    const postTitle = document.getElementById("post-title");
    const postAuthor = document.getElementById("post-author");
    const authorIcon = document.getElementById("author-icon");
    const authorName = document.getElementById("author-name");
    const postDate = document.getElementById("post-date");
    const postContent = document.getElementById("post-content");
    const postTags = document.getElementById("post-tags");
    const postMedia = document.getElementById("post-media");
    const editBtn = document.getElementById("edit-btn");
    const deleteBtn = document.getElementById("delete-btn");

    let postData = {}; 

    function checkUserPermissions() {
      onAuthStateChanged(auth, (user) => {
        if (user && postData.authorId && user.uid === postData.authorId) {
          editBtn.style.display = "inline-block";
          deleteBtn.style.display = "inline-block";

          editBtn.onclick = () => {
            window.location.href = `post-edit.html?id=${postId}&board=${board}`;
          };

          deleteBtn.onclick = async () => {
            if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              await deleteDoc(doc(db, board, postId));
              alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
              window.location.href = "bullboard.html";
            }
          };
        }
      });
    }

    loadPost();
    

    console.log("ê²Œì‹œê¸€ ë¡œë”© ì‹œì‘");
    console.log("ğŸ“Œ board:", board);
    console.log("ğŸ“Œ postId:", postId);

  </script>
  <script>
    document.getElementById("backbtn").addEventListener("click", () => {
      window.location.href = "bullboard.html";
    });

  const cloudName = "YOUR_CLOUD_NAME";  // ğŸ”¥ Cloudinary ê³„ì • ì´ë¦„
  const uploadPreset = "MiniTrickcalGames";  // ğŸ”¥ ë°©ê¸ˆ ì°¾ì€ Upload Preset ì´ë¦„
  
  async function uploadToCloudinary(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);
  
      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
          method: "POST",
          body: formData,
      });
  
      const data = await response.json();
      return data.secure_url;  // ğŸ”¥ ì—…ë¡œë“œëœ íŒŒì¼ URL ë°˜í™˜
  }

  document.getElementById("add-comment").addEventListener("click", async () => {
      const commentInput = document.getElementById("comment-input").value;
      const fileInput = document.getElementById("file-input").files[0]; // ğŸ”¥ íŒŒì¼ ì„ íƒ
  
      if (!commentInput.trim() && !fileInput) {
          return alert("resp[31] ëŒ“ê¸€ì„ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");
      }
  
      const user = auth.currentUser;
      if (!user) {
          return alert("203 ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
      }
  
      try {
          let fileUrl = "";
          if (fileInput) {
              fileUrl = await uploadToCloudinary(fileInput);  // ğŸ”¥ íŒŒì¼ ì—…ë¡œë“œ
          }
  
          const commentsRef = collection(db, `${board}/${postId}/comments`);
          await addDoc(commentsRef, {
              authorId: user.uid,
              content: commentInput.trim(),
              media: fileUrl,  // ğŸ”¥ ì—…ë¡œë“œëœ íŒŒì¼ URL ì¶”ê°€
              createdAt: serverTimestamp(),
          });
  
          document.getElementById("comment-input").value = ""; // ì…ë ¥ì¹¸ ì´ˆê¸°í™”
          document.getElementById("file-input").value = ""; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
          loadComments(board, postId); // ëŒ“ê¸€ ìƒˆë¡œê³ ì¹¨
      } catch (error) {
          console.error("error:311 <ëŒ“ê¸€ ì €ì¥ ì˜¤ë¥˜:", error);
          alert("error:311 <ëŒ“ê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ>");
      }
  });

  document.getElementById("comments-list").addEventListener("click", function (event) {
      // âœ… í†±ë‹ˆë°”í€´(âš™) í´ë¦­ ê°ì§€
      if (event.target.classList.contains("comment-options")) {
          const commentId = event.target.dataset.commentId;
          const menu = document.getElementById(`menu-${commentId}`);
  
          // âœ… ë‹¤ë¥¸ ì—´ë¦° ë©”ë‰´ ë‹«ê¸°
          document.querySelectorAll(".comment-menu").forEach((el) => {
              if (el !== menu) el.style.display = "none";
          });
  
          // âœ… í•´ë‹¹ ëŒ“ê¸€ì˜ ë©”ë‰´ í† ê¸€
          if (menu) {
              menu.style.display = menu.style.display === "block" ? "none" : "block";
          }
      }
  });

  document.addEventListener("click", function (event) {
      if (!event.target.classList.contains("comment-options")) {
          document.querySelectorAll(".comment-menu").forEach(menu => {
              menu.style.display = "none";
          });
      }
  });

    document.addEventListener("DOMContentLoaded", () => {
        const mediaUploadInput = document.getElementById("comment-media-upload");
        const mediaPreviewContainer = document.getElementById("media-preview-container");
        const mediaPreview = document.getElementById("media-preview");
        const removeMediaBtn = document.getElementById("remove-media");
        const commentInput = document.getElementById("comment-input");
        let selectedFile = null;
    
        // âœ… íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        mediaUploadInput.addEventListener("change", function (event) {
            selectedFile = event.target.files[0];
            if (!selectedFile) return;
    
            const fileURL = URL.createObjectURL(selectedFile);
            mediaPreviewContainer.style.display = "flex";
    
            if (selectedFile.type.startsWith("image/")) {
                mediaPreview.innerHTML = `<img src="${fileURL}" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 100px; height: auto; border-radius: 8px;">`;
            } else if (selectedFile.type.startsWith("video/")) {
                mediaPreview.innerHTML = `<video src="${fileURL}" controls style="max-width: 100px; height: auto; border-radius: 8px;"></video>`;
            }
        });
    
        // âœ… ë¯¸ë¦¬ë³´ê¸° ì‚­ì œ ê¸°ëŠ¥
        removeMediaBtn.addEventListener("click", () => {
            selectedFile = null;
            mediaUploadInput.value = "";
            mediaPreviewContainer.style.display = "none";
        });
    
        // âœ… ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ í´ë¦­ ì‹œ Cloudinary ì—…ë¡œë“œ í›„ textarea ìˆ˜ì •
        document.getElementById("add-comment").addEventListener("click", async () => {
            let commentText = commentInput.value.trim();
            let mediaUrl = "";
    
            if (!commentText && !selectedFile) {
                return alert("ğŸš¨ ëŒ“ê¸€ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¯¸ë””ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
            }
    
            if (selectedFile) {
                mediaUrl = await uploadToCloudinary(selectedFile);
            }
    
            // âœ… `textarea`ì— ì´ë¯¸ì§€ URLì„ ì¶”ê°€í•˜ëŠ” ëŒ€ì‹ , Firestoreì—ë§Œ ì €ì¥
            try {
                const board = "community_posts";
                const postId = "ê²Œì‹œê¸€_ID";
                const user = auth.currentUser;
                if (!user) return alert("ğŸš¨ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
    
                const commentsRef = collection(db, `${board}/${postId}/comments`);
                await addDoc(commentsRef, {
                    authorId: user.uid,
                    content: commentText, // âœ… ì´ë¯¸ì§€ ë§í¬ë¥¼ `textarea`ì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                    media: mediaUrl, // âœ… Firestoreì—ë§Œ ì´ë¯¸ì§€ URL ì €ì¥
                    createdAt: serverTimestamp(),
                });
    
                commentInput.value = "";
                selectedFile = null;
                mediaUploadInput.value = "";
                mediaPreviewContainer.style.display = "none";
    
                alert("âœ… ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
                loadComments(board, postId);
            } catch (error) {
                console.error("âŒ ëŒ“ê¸€ ì €ì¥ ì˜¤ë¥˜:", error);
                alert("ğŸš¨ ëŒ“ê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            }
        });
    });

  </script>

</body>
</html>

